# Filter Field Syntax Fix

**Date:** 2025-12-09
**Issue:** Runtime error in filter operations - "Unknown variable reference root: subject"
**Root Cause:** Stage 1 prompt showed incorrect filter field syntax
**Status:** ✅ FIXED

## Problem

Workflows generated by Stage 1 were failing at runtime with:
```
ConditionError: Condition evaluation failed: Unknown variable reference root: subject
at ConditionalEvaluator.evaluate
```

Example failing workflow:
```json
{
  "id": "step2",
  "type": "transform",
  "operation": "filter",
  "input": "{{step1.data.emails}}",
  "config": {
    "condition": {
      "conditionType": "complex_or",
      "conditions": [
        {"field": "subject", "operator": "contains", "value": "urgent"},  // ❌ WRONG
        {"field": "body", "operator": "contains", "value": "urgent"}       // ❌ WRONG
      ]
    }
  }
}
```

## Root Cause Analysis

### How Filter Operations Work

**File:** [lib/pilot/StepExecutor.ts:1098-1104](lib/pilot/StepExecutor.ts#L1098-L1104)

```typescript
const filtered = data.filter(item => {
  // Create temporary context with current item
  const tempContext = context.clone();
  tempContext.setVariable('item', item);  // ← Sets "item" as variable

  return this.conditionalEvaluator.evaluate(config.condition, tempContext);
});
```

The filter operation:
1. Iterates through array items
2. Creates a temp context for each iteration
3. **Sets the current array element as variable `item`**
4. Evaluates condition against this temp context

### How Condition Evaluator Works

**File:** [lib/pilot/ConditionalEvaluator.ts:79](lib/pilot/ConditionalEvaluator.ts#L79)

```typescript
private evaluateSimpleCondition(condition: SimpleCondition, context: ExecutionContext): boolean {
  // Resolve field value from context
  const actualValue = context.resolveVariable(`{{${condition.field}}}`);  // ← Wraps in {{}}

  return this.compareValues(actualValue, condition.value, condition.operator);
}
```

When condition has `"field": "subject"`:
- It tries to resolve `{{subject}}`
- But `subject` is not a valid variable root
- The valid reference is `{{item.subject}}`

### The Mismatch

**Stage 1 Prompt Example (BEFORE FIX):**
```json
{"field": "subject", "operator": "contains", "value": "urgent"}
```

**What Runtime Expects:**
```json
{"field": "item.subject", "operator": "contains", "value": "urgent"}
```

## Solution

Updated Stage 1 prompt in [lib/agentkit/stage1-workflow-designer.ts](lib/agentkit/stage1-workflow-designer.ts):

### 1. Added Explicit Rule (Lines 268-273)

```markdown
3. **Filter Config Format**
   MUST be nested: { condition: { field, operator, value } }
   NOT flat: { field, operator, value }
   Field references: Use "item.fieldname" to reference fields in filtered array
   ❌ WRONG: "field": "subject"
   ✅ CORRECT: "field": "item.subject"
```

### 2. Fixed Example (Lines 361-362)

**BEFORE:**
```json
{"conditionType": "simple", "field": "subject", "operator": "contains", "value": "urgent"},
{"conditionType": "simple", "field": "body", "operator": "contains", "value": "urgent"}
```

**AFTER:**
```json
{"conditionType": "simple", "field": "item.subject", "operator": "contains", "value": "urgent"},
{"conditionType": "simple", "field": "item.body", "operator": "contains", "value": "urgent"}
```

### 3. Added to Key Patterns (Line 382)

```markdown
✓ Step 2: Filter condition uses "item.fieldname" to reference array item fields
```

## Expected Impact

### Before Fix
- ❌ Generated workflows fail at runtime
- ❌ Filter conditions can't resolve field references
- ❌ Users see cryptic "Unknown variable reference root" errors

### After Fix
- ✅ Workflows use correct `"item.fieldname"` syntax
- ✅ Filter conditions resolve successfully
- ✅ Runtime execution works as expected

## Files Modified

1. **[lib/agentkit/stage1-workflow-designer.ts](lib/agentkit/stage1-workflow-designer.ts)**
   - Line 268-273: Added filter field syntax rule with examples
   - Line 361-362: Fixed filter condition field references in example
   - Line 382: Added pattern note about "item.fieldname" syntax

## Testing

### Build Verification
```bash
npm run build
# ✅ Compiled successfully
```

### Expected Workflow Output (After Fix)
```json
{
  "id": "step2",
  "type": "transform",
  "operation": "filter",
  "input": "{{step1.data.emails}}",
  "config": {
    "condition": {
      "conditionType": "complex_or",
      "conditions": [
        {"field": "item.subject", "operator": "contains", "value": "urgent"},  // ✅ CORRECT
        {"field": "item.body", "operator": "contains", "value": "urgent"}       // ✅ CORRECT
      ]
    }
  }
}
```

### Runtime Execution (After Fix)
```javascript
// StepExecutor creates temp context:
tempContext.setVariable('item', {id: "123", subject: "URGENT: Meeting", body: "..."});

// ConditionalEvaluator resolves:
context.resolveVariable("{{item.subject}}") // → "URGENT: Meeting"

// Comparison:
"URGENT: Meeting".includes("urgent") // → true ✅
```

## Why This Wasn't Caught Earlier

1. **Tool schema doesn't validate field syntax** - Only checks structure, not variable references
2. **Stage 2 doesn't touch filter conditions** - Only fills action parameters
3. **No workflow execution tests** - Generation tests stopped at JSON validation
4. **Example was untested** - Prompt example was never executed against real data

## Prevention

Going forward:
- [ ] Add workflow execution tests that run generated workflows
- [ ] Validate variable references in filter conditions during generation
- [ ] Test Stage 1 examples against actual runtime before deployment

## Related Patterns

This same `item` variable pattern is used in:

1. **Transform Map Operations** ([StepExecutor.ts:1062-1064](lib/pilot/StepExecutor.ts#L1062-L1064))
   ```typescript
   const tempContext = context.clone();
   tempContext.setVariable('item', item);
   ```

2. **Loop Operations** (documented in prompt)
   ```
   Current item in loop: {{loop.item.field_name}}
   ```

The filter operation follows the same pattern - it just wasn't documented correctly in the Stage 1 prompt.

## Conclusion

**Root cause:** Documentation error in Stage 1 prompt
**Fix:** Updated prompt to show correct `"item.fieldname"` syntax
**Impact:** Workflows will now generate with correct filter field references that work at runtime
**Confidence:** 100% (aligns with actual runtime implementation)

---

**Status:** ✅ READY FOR TESTING
**Next Step:** Generate new workflows and verify filter operations execute successfully
