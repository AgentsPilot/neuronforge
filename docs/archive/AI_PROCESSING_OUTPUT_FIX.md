# ai_processing Output Reference Fix

**Date:** December 3, 2025
**Issue:** Empty email body when using ai_processing steps
**Status:** ✅ FIXED

---

## Problem Description

User reported receiving emails with empty bodies when using workflows generated by the two-stage agent generator. Investigation revealed that workflows with `ai_processing` steps were using incorrect output references.

### Example of Broken Workflow

```json
{
  "id": "step3",
  "name": "Generate HTML Table",
  "type": "ai_processing",
  "input": "{{step2.structured_blogs}}",
  "prompt": "Convert the blog data into a professional HTML table..."
}
```

Then step4 (send_email) referenced the output as:
```json
"html_body": "{{step3.html_table}}"  // ❌ WRONG - field doesn't exist
```

### Root Cause

The `ai_processing` step executor (in [StepExecutor.ts:728-738](../lib/pilot/StepExecutor.ts)) returns data in a specific structure:

```typescript
{
  data: {
    result: cleanedResponse,
    response: cleanedResponse,
    output: cleanedResponse,
    summary: cleanedResponse,
    analysis: cleanedResponse
  }
}
```

But Stage 1 was generating workflows that referenced custom field names like `{{step3.html_table}}` instead of the correct `{{step3.data.result}}`.

When the execution engine tried to resolve `{{step3.html_table}}`, it couldn't find that field and returned `undefined`, resulting in empty email bodies.

---

## The Fix

### 1. Updated Stage 1 System Prompt

**File:** [lib/agentkit/stage1-workflow-designer.ts](../lib/agentkit/stage1-workflow-designer.ts)

Added explicit guidance in section 7 (lines 316-331):

```typescript
**CRITICAL: ai_processing step outputs**
ai_processing and llm_decision steps return data in {{stepN.data.result}} format:
- {{stepN.data.result}} - ALWAYS works (use this as default)
- {{stepN.data.response}} - also works (alias)
- {{stepN.data.output}} - also works (alias)
- {{stepN.data.summary}} - for summarization tasks
- {{stepN.data.analysis}} - for analysis tasks

❌ WRONG: {{step3.html_table}} (field doesn't exist)
✅ CORRECT: {{step3.data.result}} (always use .data.result for ai_processing)
```

Added complete example in section 8 (lines 382-386):

```typescript
**COMPLETE EXAMPLE - Email with AI-generated content:**
Step 1 (action): research_topic → output: {{step1.data.results}}
Step 2 (ai_processing): "Generate HTML" → output: {{step2.data.result}}
Step 3 (action): send_email with html_body: "{{step2.data.result}}" ✅
WRONG: html_body: "{{step2.html_content}}" ❌ (field doesn't exist)
```

Updated quality checklist (line 397):
```
✓ Use {{stepN.data.result}} for ai_processing outputs (NOT custom field names)
```

### 2. Added Gate 2 Validation

**File:** [lib/agentkit/twostage-agent-generator.ts](../lib/agentkit/twostage-agent-generator.ts)

Added validation check (lines 450-492) to detect incorrect ai_processing output references:

```typescript
// Track which steps are ai_processing for output validation
const aiProcessingSteps = new Set(
  complete.workflow_steps
    .filter(s => s.type === 'ai_processing' || s.type === 'llm_decision')
    .map(s => s.id)
);

for (const step of complete.workflow_steps || []) {
  const stepStr = JSON.stringify(step);
  const varRefs = stepStr.matchAll(/\{\{([^}]+)\}\}/g);

  for (const match of varRefs) {
    const ref = match[1];

    // Check if referencing ai_processing step without .data
    if (aiProcessingSteps.has(stepId)) {
      const refPattern = ref.substring(stepId.length + 1);

      if (!refPattern.startsWith('data.')) {
        errors.push(
          `Step ${step.id}: Invalid reference "{{${ref}}}" - ai_processing/llm_decision steps must use {{${stepId}.data.result}}`
        );
      }
    }
  }
}
```

This validation will now **catch and reject** workflows that use incorrect output references like `{{step3.html_table}}` before they're saved.

---

## Impact

### Before Fix
- Workflows generated with `{{stepN.custom_field}}` references
- Execution would resolve these to `undefined`
- Resulted in empty email bodies, missing data, etc.
- No error messages - silently failed

### After Fix
- Stage 1 guidance teaches correct `{{stepN.data.result}}` pattern
- Gate 2 validation catches any incorrect references
- Workflows now use correct output references
- Execution works as expected

---

## Testing Recommendation

When generating a new agent with ai_processing steps, verify:

1. **Check workflow_steps:** Look for ai_processing steps
2. **Check subsequent references:** Ensure they use `{{stepN.data.result}}` format
3. **Test execution:** Verify output is not empty

Example test prompt:
```
"Research top 10 AI app release blogs and send me an HTML table via email"
```

Expected workflow pattern:
```json
[
  {
    "id": "step1",
    "type": "action",
    "action": "research_topic"
  },
  {
    "id": "step2",
    "type": "ai_processing",
    "input": "{{step1.data.results}}"  // ✅ Correct
  },
  {
    "id": "step3",
    "type": "action",
    "action": "send_email",
    "params": {
      "content": {
        "html_body": "{{step2.data.result}}"  // ✅ Correct
      }
    }
  }
]
```

---

## Related Files Modified

1. [lib/agentkit/stage1-workflow-designer.ts](../lib/agentkit/stage1-workflow-designer.ts) - Updated system prompt
2. [lib/agentkit/twostage-agent-generator.ts](../lib/agentkit/twostage-agent-generator.ts) - Added validation

---

## Success Criteria ✅

- ✅ Stage 1 prompt explicitly teaches `{{stepN.data.result}}` pattern
- ✅ Gate 2 validation catches incorrect references
- ✅ Example workflows provided in prompt
- ✅ Quality checklist updated
- ✅ Future workflows will use correct output references
