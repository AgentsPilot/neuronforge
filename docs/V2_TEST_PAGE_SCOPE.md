# Test Plugins V2 Page - Complete Functionality Documentation

**Location:** `/app/test-plugins-v2/page.tsx`
**Route:** `/test-plugins-v2`
**Purpose:** Comprehensive testing interface for plugins, AI services, thread conversations, and free tier user management

---

## Overview

The Test Plugins V2 page is a multi-tabbed testing interface that provides developers and administrators with tools to test and manage various aspects of the NeuronForge system. It includes four main functional areas accessible through tabs.

---

## Tab 1: Plugins

### Purpose
Test plugin connectivity, authentication, and action execution for integrated third-party services.

### Features

#### 1.1 Plugin Management
- **View Available Plugins**: Lists all registered plugins from the system
- **Plugin Status Indicator**: Shows three connection states:
  - ðŸŸ¢ **Connected** (green): Plugin is connected with valid token
  - ðŸŸ  **Token Expired** (orange): Plugin connected but OAuth token has expired
  - ðŸ”´ **Not Connected** (red): Plugin not connected for this user
- **Connect Plugin**: Initiates OAuth flow for plugin authentication
- **Disconnect Plugin**: Removes plugin connection for a user
- **Refresh Token**: Refreshes expired OAuth token without re-authentication (shown when token is expired)

**Supported Plugins:**
- Google Mail
- Google Drive
- Google Sheets
- Google Docs
- Google Calendar
- Slack
- HubSpot
- LinkedIn
- Airtable

#### 1.2 Action Testing
- **Select Plugin**: Dropdown to choose from available plugins
- **Select Action**: Dropdown showing all actions available for selected plugin
- **Parameters Editor**: JSON textarea with parameter templates pre-populated
- **Execute Action**: Runs the selected plugin action with provided parameters

**Parameter Templates Available:**
The system includes pre-configured JSON templates for common actions across all plugins:
- Google Mail: `send_email`, `search_emails`, `create_draft`
- Google Drive: `list_files`, `search_files`, `get_file_metadata`, `read_file_content`, `get_folder_contents`
- Google Sheets: `read_range`, `write_range`, `append_rows`, `create_spreadsheet`, `get_spreadsheet_info`
- Google Docs: `read_document`, `insert_text`, `append_text`, `create_document`, `get_document_info`
- Google Calendar: `list_events`, `create_event`, `update_event`, `delete_event`, `get_event_details`
- Slack: `send_message`, `read_messages`, `update_message`, `add_reaction`, `remove_reaction`, `create_channel`, `list_channels`, `list_users`, `get_user_info`, `upload_file`
- HubSpot: `get_contact`, `get_contact_deals`, `get_contact_activities`, `search_contacts`, `get_deal`
- LinkedIn: `get_profile`, `get_user_info`, `create_post`, `get_posts`, `get_organization`, `search_organizations`, `get_organization_posts`, `get_connections`
- Airtable: `list_bases`, `list_records`, `get_record`, `create_records`, `update_records`, `list_tables`, `upload_attachment`, `get_attachment_urls`

#### 1.3 Response Display
- **Last API Response**: Shows full JSON response from last action
- **Copy to Clipboard**: Quick copy button for response data
- **Auto-scroll**: Response appears in scrollable container

**API Endpoints Used:**
- `GET /api/plugins/available` - List all available plugins
- `GET /api/plugins/user-status` - Get user's plugin connection status (includes `active_expired` array)
- `POST /api/plugins/execute` - Execute a plugin action
- `POST /api/plugins/disconnect` - Disconnect a plugin
- `POST /api/plugins/refresh-token` - Refresh expired OAuth token for a plugin

---

## Tab 2: AI Services

### Purpose
Test AI-powered services for prompt analysis, enhancement, and clarification question generation.

### Features

#### 2.1 AI Service Selection
Available AI services:
- **analyze-prompt-clarity**: Analyzes prompt clarity and completeness
- **enhance-prompt**: Enhances a prompt with additional context
- **generate-clarification-questions**: Generates questions to clarify vague prompts

#### 2.2 Request Configuration
- **Request Body Editor**: JSON textarea for request configuration
- **Generate New Session ID**: Creates fresh UUID for `sessionId` field
- **Generate New Agent ID**: Creates fresh UUID for `agentId` field
- **Reset to Template**: Restores default template with new IDs

**AI Service Templates Include:**
```json
{
  "prompt": "User's automation request",
  "userId": "test_user_123",
  "sessionId": "<auto-generated-uuid>",
  "agentId": "<auto-generated-uuid>",
  "connected_plugins": {},
  "bypassPluginValidation": false
}
```

#### 2.3 Execution & Response
- **Execute AI Service**: Calls the selected AI endpoint
- **Response Display**: Shows full AI service response
- **Copy to Clipboard**: Quick copy functionality
- **Scrollable Output**: Max height container with overflow

**API Endpoints Used:**
- `POST /api/analyze-prompt-clarity`
- `POST /api/enhance-prompt`
- `POST /api/generate-clarification-questions`

---

## Tab 3: Thread Conversation

### Purpose
Test the complete conversational agent creation workflow with phase-based processing.

### Features

#### 3.1 Session Info Panel
- **Thread ID**: Shows current thread identifier
- **Current Phase**: Displays phase 1, 2, or 3
- **Mini-Cycle Indicator**: Shows when refinement mini-cycle is active
- **Clarity Score**: Percentage showing prompt clarity
- **API Calls Tracked**: Count of all API communications
- **Download JSON**: Export all API communications as JSON file

**Captured Communications Include:**
- Init Thread calls
- Phase 1 calls (Analysis)
- Phase 2 calls (Clarification Questions)
- Phase 3 calls (Enhanced Prompt Generation)

#### 3.2 Start New Thread
- **Initial Prompt Input**: Textarea for user's automation request
- **Start Thread**: Initiates the thread and begins Phase 1

Example prompts:
```
"Send me weekly email summaries of my boss's emails to Slack"
"Create an automation that tracks project tasks"
"Monitor my calendar and send daily updates"
```

#### 3.3 Conversation History
- **Message Display**: Shows alternating user/assistant messages
- **User Messages**: Blue background with left border
- **Assistant Messages**: Yellow background with left border
- **Data Expansion**: Collapsible details showing structured data
- **Auto-scroll**: Scrollable container for long conversations

#### 3.4 Phase 2 - Clarification Questions
- **Question Display**: Shows current question with context
- **Theme/Dimension Info**: Shows categorization of question
- **Answer Input**: Textarea for user response
- **Progress Indicator**: "Question X of Y"
- **Submit Answer**: Advances to next question or Phase 3

**Mini-Cycle Detection:**
When Phase 3 detects `user_inputs_required` in the enhanced prompt, the system automatically:
1. Stores Phase 3 result
2. Sets mini-cycle flag
3. Re-runs Phase 2 to ask refinement questions
4. Generates refined Phase 3 output

#### 3.5 Phase 3 - Enhanced Prompt
- **Plan Title & Description**: High-level overview
- **Workflow Sections**:
  - Data sources
  - Actions to perform
  - Processing steps (bulleted list)
  - Output format
  - Delivery method
  - Error handling
- **Specifics**:
  - Services involved
  - User inputs required
  - Trigger scope
- **Full JSON**: Expandable section with complete enhanced prompt
- **Analysis Data**: Expandable section with analysis details

**Action Buttons:**
- **Accept Plan**: Marks plan as ready for implementation
- **Refine Further**: Returns to Phase 2 for additional questions (v8 feature)
- **Download JSON**: Exports all API communications

#### 3.6 Testing Controls
- **Reset Thread**: Clears all state and starts fresh

**API Endpoints Used:**
- `POST /api/agent-creation/init-thread` - Initialize conversation thread
- `POST /api/agent-creation/process-message` - Process each phase

**Phase Flow:**
```
User Input â†’ Phase 1 (Analysis) â†’ [If clarity < threshold] â†’ Phase 2 (Questions)
                                â†’ [If clarity sufficient] â†’ Phase 3 (Enhanced Prompt)

Phase 2 (Questions) â†’ User Answers â†’ Phase 3 (Enhanced Prompt)

Phase 3 â†’ [If user_inputs_required] â†’ Mini-Cycle Phase 2 â†’ Refined Phase 3
```

---

## Tab 4: Free Tier Users

### Purpose
Create and manage free tier user subscriptions for testing and onboarding.

### Features

#### 4.1 Info Banner
Explains the functionality:
- Creates record in `user_subscriptions` table
- User must exist in `auth.users` table
- Shows all quotas that will be allocated

#### 4.2 User ID Input
- **UUID Input Field**: Accepts user ID from auth.users table
- **Placeholder**: Shows example UUID format
- **Helper Text**: Explains where to find the user ID
- **Validation**: Disables submit if empty

#### 4.3 What Will Be Created
Information panel showing default allocations:
- **Pilot Tokens**: 20,834 tokens (from `system_settings_config`)
- **Storage Quota**: 1,000 MB (from `system_settings_config`)
- **Execution Quota**: Unlimited (null)
- **Free Tier Duration**: 30 days (from `system_settings_config`)
- **Status**: active
- **Account Frozen**: false

**Important Note:**
If user already has a subscription, free tier allocation is ADDED to existing balance.

#### 4.4 Action Buttons
- **Create Free Tier Subscription**: Calls API to allocate quotas
- **Reset Form**: Clears form and response

#### 4.5 Response Display
**Success Response (Green):**
- âœ… Success header
- Allocation Details box showing:
  - Pilot Tokens allocated
  - Raw Tokens (LLM tokens)
  - Storage MB
  - Executions quota
  - Success message
- Full JSON expansion

**Error Response (Red):**
- âŒ Error header
- Error message box
- Full JSON expansion

**All Responses Include:**
- Copy to Clipboard button
- Expandable full API response

**API Endpoint Used:**
- `POST /api/onboarding/allocate-free-tier`

**Request Format:**
```json
{
  "userId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Success Response Format:**
```json
{
  "success": true,
  "allocation": {
    "pilot_tokens": 20834,
    "raw_tokens": 208340000,
    "storage_mb": 1000,
    "executions": null
  },
  "message": "Free tier quotas allocated successfully"
}
```

**What Happens in Database:**
1. Checks if `user_subscriptions` record exists for user
2. If exists: Updates record, adds to balance
3. If not exists: Creates new record with:
   - `user_id`
   - `balance` (raw tokens)
   - `total_earned`
   - `storage_quota_mb`
   - `storage_used_mb`: 0
   - `executions_quota`
   - `executions_used`: 0
   - `status`: 'active'
   - `free_tier_granted_at`
   - `free_tier_expires_at`
   - `free_tier_initial_amount`
   - `account_frozen`: false
4. Logs to audit trail with action: `FREE_TIER_ALLOCATED`

---

## Global Features

### User Configuration Panel
Present on all tabs:
- **User ID Input**: Enter user UUID for testing
- **Status Display**: Shows plugin counts by status:
  - Connected count
  - Expired count (shown in orange when > 0)
  - Disconnected count

### Control Panel
- **Refresh Status**: Reloads plugins and user status
- **Clear Debug Logs**: Clears the debug log display

### Debug Logs Panel
- **Real-time Logging**: Shows all operations with timestamps
- **Color-coded**:
  - ðŸŸ¢ Green: Success messages
  - ðŸ”´ Red: Error messages
  - âšª Gray: Info messages
- **Scrollable**: Auto-scrolls to show latest logs
- **Limit**: Keeps last 50 log entries

---

## Technical Architecture

### State Management

**Core State:**
```typescript
- userId: string
- apiClient: PluginAPIClient
- availablePlugins: PluginInfo[]
- userStatus: UserPluginStatus | null
- selectedPlugin: string
- selectedAction: string
- parameters: string (JSON)
- lastResponse: any
- isLoading: boolean
```

**AI Services State:**
```typescript
- selectedAIService: string
- aiServiceRequestBody: string (JSON)
- aiServiceResponse: any
```

**Thread Conversation State:**
```typescript
- threadId: string | null
- currentPhase: 1 | 2 | 3
- initialPrompt: string
- conversationHistory: Array<{role, content, data}>
- currentQuestions: any[]
- currentQuestionIndex: number
- userAnswer: string
- clarificationAnswers: Record<string, string>
- enhancedPrompt: any
- clarityScore: number
- analysisData: any
- missingPlugins: string[]
- isInMiniCycle: boolean
- miniCyclePhase3: any
- apiCommunications: Array<{timestamp, phase, endpoint, request, response}>
```

**Free Tier Users State:**
```typescript
- freeTierUserId: string
- freeTierResponse: any
```

**Debug State:**
```typescript
- debugLogs: DebugLog[]
```

### Key Functions

**Plugin Management:**
- `loadAvailablePlugins()` - Fetch all plugins
- `loadUserStatus()` - Get user's connection status
- `getPluginStatus(pluginKey)` - Returns 'connected', 'token_expired', or 'not_connected'
- `connectPlugin(pluginKey)` - Initiate OAuth
- `disconnectPlugin(pluginKey)` - Remove connection
- `refreshPluginToken(pluginKey)` - Refresh expired OAuth token
- `executeAction()` - Execute plugin action
- `updateParameterTemplate()` - Load action template

**AI Services:**
- `generateNewSessionId()` - Create UUID for session
- `generateNewAgentId()` - Create UUID for agent
- `resetToAITemplate()` - Load service template
- `executeAIService()` - Call AI endpoint

**Thread Conversation:**
- `startThread()` - Initialize thread
- `processMessage(phase, answers?, threadId?)` - Process phase
- `handleAnswerSubmit()` - Submit clarification answer
- `handleRefinePlan()` - Return to Phase 2
- `handleAcceptPlan()` - Accept final plan
- `resetThreadConversation()` - Clear all state
- `downloadCommunicationHistory()` - Export JSON

**Free Tier Users:**
- `createFreeTierUser()` - Call allocation API
- `resetFreeTierForm()` - Clear form

**Utilities:**
- `addDebugLog(type, message)` - Log to debug panel
- `copyToClipboard()` - Copy response to clipboard
- `refreshAll()` - Reload all data
- `clearLogs()` - Clear debug logs

---

## Use Cases

### UC-1: Test Plugin Connection
1. Enter User ID
2. Navigate to Plugins tab
3. Select plugin from dropdown
4. Click "Connect" button
5. View connection status
6. Check Debug Logs for OAuth flow

### UC-2: Refresh Expired Plugin Token
1. Enter User ID
2. Navigate to Plugins tab
3. Select plugin showing "Token Expired" (orange)
4. Click "Refresh Token" button
5. Check Debug Logs for refresh result
6. If failed, reconnect plugin via OAuth

### UC-3: Execute Plugin Action
1. Ensure plugin is connected (not expired)
2. Select action from dropdown
3. Review/edit JSON parameters
4. Click "Execute Action"
5. View response in display panel
6. Copy response if needed

### UC-4: Test AI Prompt Analysis
1. Navigate to AI Services tab
2. Select "analyze-prompt-clarity"
3. Edit prompt in request body
4. Generate new Session/Agent IDs
5. Click "Execute AI Service"
6. Review clarity score and analysis

### UC-5: Run Complete Thread Conversation
1. Enter User ID
2. Navigate to Thread Conversation tab
3. Enter initial prompt
4. Click "Start Thread"
5. Observe Phase 1 analysis
6. Answer Phase 2 questions (if needed)
7. Review Phase 3 enhanced prompt
8. Download communication history

### UC-6: Create Free Tier User
1. Navigate to Free Tier Users tab
2. Enter user UUID
3. Review allocation details
4. Click "Create Free Tier Subscription"
5. View success/error response
6. Check Debug Logs for details

### UC-7: Debug Mini-Cycle Workflow
1. Start thread with vague prompt requiring user inputs
2. Complete Phase 1 and Phase 2
3. Observe Phase 3 generating `user_inputs_required`
4. Watch automatic mini-cycle activation
5. Answer refinement questions
6. Review refined Phase 3 output
7. Download full communication history

---

## System Config Dependencies

The test page relies on these system configuration tables:

### `system_settings_config`
Used by Free Tier Users tab:
- `free_tier_pilot_tokens` (default: 20834)
- `free_tier_storage_mb` (default: 1000)
- `free_tier_executions` (default: null/unlimited)
- `free_tier_duration_days` (default: 30)

### `ais_system_config`
Used for token conversion:
- `pilot_credit_cost_usd` (price per Pilot Credit)
- `tokens_per_pilot_credit` (conversion ratio)

---

## Error Handling

### Common Errors

**Authentication Errors:**
- Missing or invalid User ID
- Expired session
- OAuth flow interruption

**Plugin Errors:**
- Plugin not connected
- Invalid parameters
- API rate limits
- Service unavailable

**AI Service Errors:**
- Invalid JSON in request body
- Missing required fields
- Service timeout
- Model errors

**Thread Conversation Errors:**
- Thread not initialized
- Invalid phase transition
- Missing clarification answers
- API communication failure

**Free Tier Errors:**
- User ID not found in auth.users
- User already has active subscription
- System config not found
- Database constraint violation

### Error Display
All errors are:
1. Logged to Debug Logs with timestamp
2. Displayed in response panels with red styling
3. Shown with detailed error messages
4. Available for clipboard copy

---

## Performance Considerations

### Optimization Features
- **Lazy Loading**: Plugins loaded on mount only
- **Conditional Rendering**: Only active tab is rendered
- **Debouncing**: User ID changes trigger status reload
- **Log Limiting**: Debug logs capped at 50 entries
- **JSON Validation**: Parameters validated before execution

### Loading States
- Global `isLoading` state prevents concurrent operations
- Button states reflect loading/disabled conditions
- Clear visual feedback during API calls

---

## Security Notes

### Authentication
- All API calls require valid user authentication
- User ID passed as header: `x-user-id`
- Session/Agent IDs tracked for audit trails
- OAuth tokens managed server-side

### Data Privacy
- Sensitive data not logged to debug panel
- Plugin credentials never exposed to client
- API responses may contain user data (handle carefully)
- Audit trail logs all free tier allocations

---

## Future Enhancements

### Planned Features
1. **Bulk Plugin Testing**: Test multiple actions sequentially
2. **Response Comparison**: Compare responses across API versions
3. **Template Management**: Save/load custom parameter templates
4. **User Search**: Lookup users by email instead of UUID
5. **Quota Management**: View and edit user quotas directly
6. **Real-time Logs**: WebSocket connection for live logs
7. **Export History**: Download plugin execution history
8. **Performance Metrics**: Track API response times

---

## Troubleshooting

### Issue: Plugin Won't Connect
- Check if user ID is valid
- Verify OAuth credentials in environment
- Check plugin status in database
- Review Debug Logs for OAuth errors

### Issue: Plugin Shows Token Expired
- Click "Refresh Token" button to refresh OAuth token
- If refresh fails, the refresh token may have expired - reconnect the plugin
- Check Debug Logs for specific refresh error messages
- Some plugins may not support token refresh - reconnect required

### Issue: Action Execution Fails
- Ensure plugin is connected (not expired)
- If token expired, refresh token first
- Validate JSON parameters syntax
- Check parameter template matches action schema
- Verify user has permissions for action

### Issue: Thread Gets Stuck
- Check API endpoint availability
- Verify phase transitions in logs
- Clear thread and restart
- Check for missing clarification answers

### Issue: Free Tier Creation Fails
- Verify user exists in auth.users
- Check system_settings_config values
- Ensure user doesn't have conflicting subscription
- Review database constraint errors

---

## Related Documentation

- [Plugin System Architecture](./PLUGIN_SYSTEM_ARCHITECTURE.md)
- [Conversational UI Phase Guide](./V2_CONVERSATIONAL_UI_NEW_COMPLETE.md)
- [AI Services Integration](./AI_SERVICES_GUIDE.md)
- [Free Tier Management](./FREE_TIER_MANAGEMENT.md)
- [Stripe Integration Setup](./STRIPE_INTEGRATION_SETUP.md)

---

## Changelog

### Version 1.1 (Current)
- Added three-state plugin status: Connected, Token Expired, Not Connected
- Added "Refresh Token" button for expired plugins
- Updated status summary to show expired plugin count
- Plugin dropdown now shows [Expired] suffix for expired tokens
- Color-coded status: green (connected), orange (expired), red (disconnected)

### Version 1.0
- Initial release with 4 tabs
- Plugin management and testing
- AI service testing
- Thread conversation workflow
- Free tier user creation
- Debug logging system
- Communication history export

---

## Support

For issues or questions about the Test Page:
- Check Debug Logs for detailed error messages
- Review API endpoint documentation
- Verify system configuration values
- Contact development team with exported JSON logs

---

**Last Updated:** December 2025
**Maintained By:** NeuronForge Development Team
