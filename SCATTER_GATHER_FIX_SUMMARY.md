# Scatter-Gather Variable Reference Bug Fix

## Problem Summary

Your scatter_gather workflow was failing because of **incorrect variable references** being generated by the AI agent creation system. This is a **systemic issue** affecting all agents that use scatter_gather patterns.

## Root Cause

### Issue 1: Incorrect Example in Training Data
The workflow designer (stage1-workflow-designer.ts) had an **incorrect example** on line 600:

**Wrong:** `{{step4.data.all_analyses}}`
**Correct:** `{{step4.data}}`

This example was teaching the AI to generate wrong variable references.

### Issue 2: Misleading Schema Documentation
The gather configuration had an `outputKey` field described as "Key to store gathered results", but this field is **completely ignored** by the execution engine. Results are ALWAYS stored directly in `{{stepN.data}}`.

### Issue 3: Your Workflow Had Wrong References
Your expense processing workflow had:
- **Line 34:** `"input": "{{step1.emails}}"` → Should be `"{{step1.data.emails}}"`
- **Line 60:** `"input": "{{step3.all_expense_data}}"` → Should be `"{{step3.data}}"`

## How Scatter-Gather Actually Works

### Output Storage
When a scatter_gather step executes:

1. **Scatter Phase:** Items are processed in parallel
2. **Gather Phase:** Results are aggregated based on operation:
   - `collect` → Returns array of all results
   - `merge` → Returns merged object
   - `reduce` → Returns reduced value
3. **Storage:** The gathered result is stored **directly** in `stepN.data`

From [WorkflowPilot.ts:767](lib/pilot/WorkflowPilot.ts#L767):
```typescript
context.setStepOutput(stepDef.id, {
  stepId: stepDef.id,
  plugin: 'system',
  action: 'scatter_gather',
  data: results,  // ← Gathered results go directly here
  metadata: { ... }
});
```

### Variable Reference Rules

✅ **CORRECT References:**
- `{{stepN.data}}` - Always use this for scatter_gather outputs
- `{{step1.data.emails}}` - For plugin action outputs (check plugin's output_fields)
- `{{step3.data.result}}` - For ai_processing outputs

❌ **WRONG References:**
- `{{stepN.data.outputKey}}` - outputKey is ignored
- `{{stepN.data.all_results}}` - No nested structure created
- `{{stepN.emails}}` - Missing .data accessor

## Files Fixed

### 1. [lib/agentkit/stage1-workflow-designer.ts](lib/agentkit/stage1-workflow-designer.ts)

**Fix 1:** Corrected example (line 600)
```diff
- "input": "Best Practices: {{step3.data.result}}\n\nCurrent Documentation Analysis: {{step4.data.all_analyses}}",
+ "input": "Best Practices: {{step3.data.result}}\n\nCurrent Documentation Analysis: {{step4.data}}",
```

**Fix 2:** Added critical documentation (after line 355)
```markdown
**CRITICAL: scatter_gather Output References**

Scatter-gather results are stored DIRECTLY in {{stepN.data}}, NOT in a nested field.
The gather.outputKey field in the schema is IGNORED by the execution engine.

✅ CORRECT: {{step3.data}} - Always use this for scatter_gather outputs
❌ WRONG: {{step3.data.outputKey}} - This will fail (outputKey is ignored)
❌ WRONG: {{step3.data.all_results}} - This will fail (no nested structure)
```

**Fix 3:** Removed misleading outputKey from example (line 594)
```diff
  "gather": {
-   "operation": "collect",
-   "outputKey": "all_analyses"
+   "operation": "collect"
  }
```

**Fix 4:** Updated schema documentation (line 986)
```diff
- outputKey: { type: 'string', description: 'Key to store gathered results' },
+ outputKey: { type: 'string', description: 'DEPRECATED: This field is ignored. Results are always stored in {{stepN.data}}' },
```

### 2. [lib/pilot/schema/pilot-dsl-schema.ts](lib/pilot/schema/pilot-dsl-schema.ts)

**Fix:** Updated outputKey description (line 349)
```diff
  outputKey: {
    type: "string",
-   description: "Key to store the gathered result"
+   description: "DEPRECATED: This field is ignored. Results are always stored in {{stepN.data}}"
  },
```

### 3. [corrected-workflow.json](corrected-workflow.json)

Created corrected version of your expense workflow with proper variable references.

## Your Corrected Workflow

Key changes:
1. **Step 3 scatter input:** Changed from `{{step1.emails}}` to `{{step1.data.emails}}`
2. **Step 4 transform input:** Changed from `{{step3.all_expense_data}}` to `{{step3.data}}`
3. **Step 2 condition:** Added proper check using `{{step1.data.total_found}}`

## Testing

The enhanced logging in [ParallelExecutor.ts](lib/pilot/ParallelExecutor.ts) is still active and will show:
- What scatter input resolves to
- Available variables in context
- Sample of scatter results
- Final gathered result

This will help verify the fix works when you run agents.

## Impact

### Before Fix
- **All** agents using scatter_gather would generate incorrect variable references
- Workflows would fail at the step after scatter_gather with "no input data" error
- Users would need to manually fix every generated workflow

### After Fix
- Agent generation will now produce correct variable references
- Scatter_gather workflows will execute successfully
- Clear documentation prevents future confusion

## Verification Steps

1. **Regenerate your expense agent** - The AI should now generate correct references
2. **Check the console logs** - Enhanced logging will show the data flow
3. **Verify step4 receives data** - Transform step should now have input

## Additional Notes

- The `outputKey` field is kept in the schema for backwards compatibility but marked as deprecated
- Gmail plugin returns data in `step.data.emails` (not `step.emails`)
- All plugin actions store output in `step.data.<field_name>` where field names come from the plugin's output_schema
- AI processing steps store output in `step.data.result`
- Transform steps store output in `step.data`

## Related Documentation

- [ExecutionContext.ts:233-247](lib/pilot/ExecutionContext.ts#L233-L247) - Variable resolution logic
- [ParallelExecutor.ts:288-318](lib/pilot/ParallelExecutor.ts#L288-L318) - Gather operations
- [WorkflowPilot.ts:759-783](lib/pilot/WorkflowPilot.ts#L759-L783) - Scatter-gather execution
- [google-mail-plugin-v2.json:224-252](lib/plugins/definitions/google-mail-plugin-v2.json#L224-L252) - Gmail output schema
